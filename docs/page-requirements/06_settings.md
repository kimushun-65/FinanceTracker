# 設定ページ 設計書

## ページ概要
ユーザープロファイル、カテゴリ管理、通知設定など、アプリケーション全体の設定を管理するページです。

## 主要機能

### 1. プロファイル管理
- **表示項目**:
  - プロフィール画像（アバター）
  - ユーザー名
  - メールアドレス
  - 登録日
  - プラン情報
- **編集機能**:
  - プロフィール画像アップロード
  - ユーザー名変更
  - メールアドレス変更（確認メール送信）
  - パスワード変更

### 2. カテゴリ管理
- **カテゴリ一覧**:
  - デフォルトカテゴリ（編集不可）
  - カスタムカテゴリ（追加・編集・削除可）
- **カテゴリ設定**:
  - カテゴリ名
  - アイコン選択
  - 色設定
  - 有効/無効切り替え
  - 並び順変更（ドラッグ&ドロップ）
- **階層管理**: 親子カテゴリの設定

### 3. 通知設定
- **メール通知**:
  - 週次レポート送信（ON/OFF）
  - 月次レポート送信（ON/OFF）
  - 予算超過アラート（ON/OFF）
  - 閾値設定（70%、80%、90%）
- **アプリ内通知**:
  - リアルタイムアラート
  - 通知音設定
- **通知スケジュール**:
  - 送信時刻設定
  - 送信曜日設定（週次の場合）

### 4. データ管理
- **エクスポート**:
  - 全データエクスポート（CSV/JSON）
  - 期間指定エクスポート
  - カテゴリ別エクスポート
- **インポート**:
  - CSVファイルインポート
  - 他アプリからのデータ移行
  - インポート履歴
- **データ削除**:
  - 期間指定削除
  - 全データ削除（確認必須）

### 5. 表示設定
- **言語設定**: 日本語/英語
- **通貨設定**: 円/ドル/ユーロ
- **日付形式**: YYYY/MM/DD、MM/DD/YYYY
- **数値表示**: 3桁区切り、小数点以下桁数
- **テーマ**: ライト/ダーク（将来実装）

### 6. 連携設定
- **外部サービス連携**:
  - Google Calendar同期
  - 銀行API連携（将来実装）
- **API設定**:
  - APIキー発行・管理
  - Webhook設定

## データ取得要件

### 必要なAPI
1. **ユーザー情報取得API**
   - エンドポイント: `/api/users/profile`
   - レスポンス: ユーザー詳細情報

2. **ユーザー情報更新API**
   - エンドポイント: `/api/users/profile`
   - メソッド: PUT
   - リクエスト:
     ```json
     {
       "name": "新しいユーザー名",
       "email": "new@example.com"
     }
     ```

3. **カテゴリ管理API**
   - 一覧取得: `GET /api/categories`
   - 作成: `POST /api/categories`
   - 更新: `PUT /api/categories/{id}`
   - 削除: `DELETE /api/categories/{id}`
   - 並び順更新: `PUT /api/categories/order`

4. **通知設定API**
   - 取得: `GET /api/settings/notifications`
   - 更新: `PUT /api/settings/notifications`
   - リクエスト:
     ```json
     {
       "weekly_report": true,
       "monthly_report": true,
       "budget_alert": true,
       "budget_alert_threshold": 80
     }
     ```

5. **データエクスポートAPI**
   - エンドポイント: `/api/data/export`
   - パラメータ:
     - format: csv/json
     - from: 開始日
     - to: 終了日
   - レスポンス: ダウンロードURL

### データベース参照
- `users`テーブル: ユーザー情報
- `categories`テーブル: カテゴリ設定
- `category_master`テーブル: デフォルトカテゴリ

## UI/UX要件

### レイアウト
- **セクション分け**: アコーディオンまたはタブ形式
- **設定項目グループ化**: 関連項目をまとめて表示
- **保存ボタン**: 各セクションごとまたは一括保存

### バリデーション
- **メールアドレス**: 形式チェック、重複チェック
- **パスワード**: 強度チェック、確認入力
- **カテゴリ名**: 必須入力、重複チェック

### フィードバック
- **保存成功**: トースト通知
- **エラー表示**: インライン表示
- **確認ダイアログ**: 削除操作時

## セキュリティ要件

### 認証・認可
- **パスワード変更**: 現在のパスワード確認必須
- **メールアドレス変更**: 確認メール送信
- **セッション管理**: 設定変更後の再認証

### データ保護
- **エクスポートデータ**: 暗号化ZIP
- **APIキー**: 表示時マスキング
- **削除操作**: 論理削除後、物理削除

## ビジネスロジック

### カテゴリ管理ルール
- **デフォルトカテゴリ**: 削除・名称変更不可
- **使用中カテゴリ**: 削除時は取引の再カテゴリ化必要
- **階層制限**: 2階層まで

### 通知ルール
- **送信時刻**: ユーザーのタイムゾーン考慮
- **失敗時リトライ**: 3回まで再送信
- **配信停止**: メール内リンクから可能

## 実装優先順位
1. 基本的なプロファイル表示・編集
2. カテゴリ管理機能
3. 通知設定
4. データエクスポート機能
5. 高度な設定（言語、テーマ等）

## 画面設計（ASCII）

```
+--------------------------------------------------------------------------------------------------+
|  FinSight                                                               AI User | Premium Plan    |
+----------------+---------------------------------------------------------------------------------+
| ≡ Dashboard    |                              Settings                                           |
|                |                                                                                 |
| 📊 Transactions | +-----------------------------------------------------------------------+       |
|                | | Profile                                                               |       |
| 💰 Budget       | |  ┌─────┐                                                             |       |
|                | |  │ 👤  │  AI User                                                    |       |
| 📈 Assets       | |  └─────┘  ai.user@example.com                                       |       |
|                | |           Member since: 2025/01/01                                   |       |
| 📑 Reports      | |           [Edit Profile]                                             |       |
|                | +-----------------------------------------------------------------------+       |
| ⚙️ Settings     |                                                                                 |
|                | +-----------------------------------------------------------------------+       |
|                | | Category Management                                                   |       |
|                | | ┌─────────────────────────────────────────────────────────────────┐ |       |
|                | | │ Category Name        │ Status   │ Type      │ Actions          │ |       |
|                | | ├─────────────────────┼──────────┼───────────┼──────────────────┤ |       |
|                | | │ 🍎 Food (食費)       │ ✓ Active │ Default   │                  │ |       |
|                | | │ 🏠 Household (家賃)  │ ✓ Active │ Default   │                  │ |       |
|                | | │ ⚡ Utilities (光熱費) │ ✓ Active │ Default   │                  │ |       |
|                | | │ 🚃 Transportation    │ ✓ Active │ Default   │                  │ |       |
|                | | │ 🎬 Entertainment     │ ✓ Active │ Default   │                  │ |       |
|                | | │ 📦 Others (その他)   │ ✓ Active │ Default   │                  │ |       |
|                | | │ 💰 Salary (給与)     │ ○ Inactive│ Default   │                  │ |       |
|                | | │ 🏥 Medical (医療費)  │ ✓ Active │ Custom    │ [Edit] [Delete]  │ |       |
|                | | └─────────────────────────────────────────────────────────────────┘ |       |
|                | |                                              [+ Add Category]        |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | +-----------------------------------------------------------------------+       |
|                | | Notification Settings                                                 |       |
|                | | ┌─────────────────────────────────────────────┬─────────────────────┐ |       |
|                | | │ Weekly report emails                       │ [ON ] OFF           │ |       |
|                | | │ Monthly report emails                      │ [ON ] OFF           │ |       |
|                | | │ Budget overage alerts                      │  ON [OFF]           │ |       |
|                | | │   Alert threshold                          │ [80%  ▼]            │ |       |
|                | | │ Transaction reminders                      │ [ON ] OFF           │ |       |
|                | | └─────────────────────────────────────────────┴─────────────────────┘ |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | +-----------------------------------------------------------------------+       |
|                | | Data Management                                                       |       |
|                | | [Export All Data]  [Import Data]  [Delete Account]                   |       |
|                | +-----------------------------------------------------------------------+       |
+----------------+---------------------------------------------------------------------------------+
```

### 画面要素説明

#### プロファイルセクション（上部）
- **アバター**: 丸形のプレースホルダー
- **ユーザー情報**: 名前、メールアドレス、登録日
- **編集リンク**: プロファイル編集画面へ

#### カテゴリ管理セクション（中央上）
- **テーブル形式**:
  - カテゴリ名（アイコン付き）
  - ステータス（✓Active/○Inactive）
  - タイプ（Default/Custom）
  - アクション（カスタムのみEdit/Delete）
- **カテゴリ追加ボタン**: テーブル下部

#### 通知設定セクション（中央下）
- **トグルスイッチ**: ON/OFF切り替え
- **閾値設定**: ドロップダウンで選択
- **項目**:
  - 週次レポート
  - 月次レポート
  - 予算超過アラート
  - 取引リマインダー

#### データ管理セクション（下部）
- **エクスポート**: 全データダウンロード
- **インポート**: データアップロード
- **アカウント削除**: 危険操作として赤色表示

#### 視覚的要素
- アイコンでカテゴリを識別
- トグルスイッチで設定状態を明確化
- アクティブ/非アクティブの視覚的区別