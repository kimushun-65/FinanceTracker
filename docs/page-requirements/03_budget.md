# 予算設定ページ 設計書

## ページ概要
今月の予算を設定・編集するページです。先月の支出データとAIの提案を参考に、カテゴリごとの予算を決定できます。リアルタイムの予算消化状況も確認可能です。

## 主要機能

### コアビジネス機能
- **今月予算設定**: カテゴリ別の今月予算を決定・編集
- **先月実績参照**: 先月の支出データを基に今月予算を調整
- **AI予算最適化**: 過去データ分析による最適予算提案
- **リアルタイム進捗監視**: 今月の予算消化状況を即座反映

### 1. 先月実績レビューセクション
- **先月支出サマリー**: カテゴリ別の先月支出実績
- **前月比増減**: 各カテゴリの増減傾向表示
- **支出パターン分析**: 
  - 週別支出パターン
  - 突発的な大きな支出のハイライト
  - 平均より大幅に多い/少ないカテゴリの強調

### 2. 今月予算設定セクション
- **総予算額**: 全カテゴリの今月予算合計
- **カテゴリ別予算設定**:
  - 食費
  - 交通費
  - 家賃・住居費
  - エンターテインメント
  - 光熱費
  - その他
- **表示内容（各カテゴリ）**:
  - 先月実績額（参考値）
  - 今月予算額（編集可能）
  - AI提案額（適用ボタン付き）
  - 差分表示

### 3. AI予算提案セクション
- **AI分析結果**: 
  - 過去3-6ヶ月のデータ分析
  - 季節性考慮（例: 夏の光熱費上昇）
  - トレンド予測
- **提案内容**:
  - カテゴリ別推奨予算額
  - 調整理由の説明
  - 予想節約額
- **アクション**:
  - 「すべて適用」ボタン
  - カテゴリ別に個別適用

### 4. 今月進捗モニタリング
- **リアルタイム進捗表示**: 
  - 各カテゴリの今月消化状況
  - 進捗バー（色分け）
  - 残り日数を考慮したペース表示
- **進捗バーの色分け**:
  - 0-70%: 緑色（安全圏）
  - 70-90%: 黄色（注意）
  - 90-100%: オレンジ（警告）
  - 100%超: 赤色（超過）

### 5. 予算編集機能
- **インライン編集**: 各カテゴリの予算額をクリックして編集
- **クイック調整**: +1000円/-1000円ボタン
- **プリセット選択**: 
  - 先月と同じ
  - AI提案を適用
  - ゼロベース
- **保存とキャンセル**: 変更の確定または破棄

## 対応API・テーブル・ドメイン情報

### 関連API
1. **GET /budgets/current**
   - 現在月の予算情報取得（リアルタイム進捗計算含む）
   - レスポンス: カテゴリ別予算・実績・進捗率・アラート情報・AI推奨事項

2. **GET /budgets**
   - 指定月の予算情報取得
   - クエリパラメータ: year (年), month (月)
   - 過去月の予算実績参照・履歴データ取得用

3. **POST /budgets**
   - 月別予算新規作成
   - リクエスト: year, month, categories (カテゴリ別予算額配列)
   - バリデーション: 必須カテゴリチェック・金額妥当性検証

4. **PUT /budgets/{budgetId}**
   - 予算情報更新（インライン編集、一括編集）
   - パラメータ: budgetId (予算ID)
   - リアルタイムの進捗率更新を伴う

5. **GET /budget-suggestions**
   - AI予算提案一覧取得
   - 最新の最適化提案を取得

6. **POST /budget-suggestions/generate**
   - AI予算提案生成
   - リクエスト: target_month, optimization_type
   - 過去実績をベースにした推奨予算案を生成

7. **PUT /budget-suggestions/{suggestionId}/accept**
   - AI提案の承認・適用
   - 選択した提案を予算に反映

8. **PUT /budget-suggestions/{suggestionId}/reject**
   - AI提案の却下
   - 提案を却下し、フィードバックを記録

### 対応テーブル
- **budgets**: 月別カテゴリ別予算設定（月, カテゴリ, 予算額）
- **budget_suggestions**: AI提案履歴（提案理由、適用状況）
- **transactions**: 実績計算用ソースデータ（カテゴリ別支出集計）
- **categories**: 予算対象カテゴリマスタ

### 関連ドメインエンティティ
- **Budget集約**: 予算計画のライフサイクル管理
  - Budgetエンティティ: 月別カテゴリ別予算
  - BudgetStatus値オブジェクト: 進捗率・アラートレベル計算
  - Month値オブジェクト: 月度管理
- **BudgetSuggestion集約**: AI提案ロジックと履歴管理
- **Transaction集約**: 実績データ参照（予算照合用）
- **Category集約**: 予算カテゴリ分類ロジック

## UI/UX要件

### ビジュアル要素
- **プログレスバー**: アニメーション付き
- **数値変更**: トランジション効果
- **超過警告**: 点滅またはハイライト表示

### インタラクティブ要素
- **ドラッグ調整**: スライダーで予算額調整
- **クイック設定**: +1000円/-1000円ボタン
- **プリセット**: よくある予算パターン選択

### 通知機能
- **予算超過アラート**: 90%到達時
- **月初リマインダー**: 予算設定促進
- **AIからの提案通知**: 改善余地がある場合

## ビジネスロジック

### 予算計算ルール
- **デフォルト予算**: 前月実績の平均値
- **最小予算額**: カテゴリごとに0円以上
- **合計制限**: 収入予測の範囲内で警告

### AI提案ロジック
- **分析対象**: 過去3-6ヶ月の実績
- **考慮要素**:
  - 季節性（光熱費など）
  - トレンド（増加/減少傾向）
  - 類似ユーザーとの比較
- **提案精度**: 信頼度スコア表示

## 実装優先順位
1. 基本的な予算表示・編集機能
2. 実績との対比表示
3. 進捗バーとビジュアル表現
4. AI予算提案機能
5. 高度な分析・比較機能

## 画面設計（ASCII）

```
+--------------------------------------------------------------------------------------------------+
|  FinSight                                                               AI User | Premium Plan    |
+----------------+---------------------------------------------------------------------------------+
| ≡ Dashboard    |                         Budget Management - December 2025                      |
|                |                                                                                 |
| 📊 Transactions | [ This Month Budget ] [ Last Month Review ] [ AI Suggestions ]                  |
|                | ────────────────────────────────────────────────────────────────────────────── |
| 💰 Budget       |                                                                                 |
|                | December 2025 Budget Setting                                                    |
| 📈 Assets       | +-----------------------------------------------------------------------------+ |
|                | | Category          Last Month    This Month Budget    AI Suggestion  Action  | |
| 📑 Reports      | +-----------------------------------------------------------------------------+ |
|                | | 🍎 Food           ¥35,220       [¥50,000_____]      ¥45,000       [Apply]  | |
| ⚙️ Settings     | | 🚃 Transportation ¥9,850        [¥12,000_____]      ¥12,000       [Apply]  | |
|                | | 🏠 Household      ¥90,000       [¥90,000_____]      ¥90,000       [Apply]  | |
|                | | 🎬 Entertainment  ¥18,930       [¥20,000_____]      ¥20,000       [Apply]  | |
|                | | ⚡ Utilities      ¥4,890        [¥7,000______]      ¥7,000        [Apply]  | |
|                | | 📦 Others         ¥12,340       [¥15,000_____]      ¥15,000       [Apply]  | |
|                | +-----------------------------------------------------------------------------+ |
|                | | Total:            ¥171,230      ¥184,000            ¥184,000               | |
|                | +-----------------------------------------------------------------------------+ |
|                |                                                                                 |
|                | Monthly Progress (1-31 Dec)                                                     |
|                | +-----------------------------------------------------------------------------+ |
|                | | Food:          ¥5,432 / ¥50,000  [██░░░░░░░░░░░░░░░░░░] 11%                | |
|                | | Transportation: ¥1,200 / ¥12,000  [██░░░░░░░░░░░░░░░░░░] 10%                | |
|                | | Household:     ¥90,000 / ¥90,000 [████████████████████] 100%               | |
|                | | Entertainment:  ¥2,100 / ¥20,000  [██░░░░░░░░░░░░░░░░░░] 11%                | |
|                | | Utilities:      ¥0 / ¥7,000       [░░░░░░░░░░░░░░░░░░░░] 0%                 | |
|                | | Others:         ¥1,340 / ¥15,000  [█░░░░░░░░░░░░░░░░░░░] 9%                 | |
|                | +-----------------------------------------------------------------------------+ |
|                |                                                                                 |
|                | [Apply All AI Suggestions] [Save Budget] [Reset to Last Month]                  |
|                |                                                                                 |
+----------------+---------------------------------------------------------------------------------+

タブ「Last Month Review」選択時:
+--------------------------------------------------------------------------------------------------+
|  FinSight                                                               AI User | Premium Plan    |
+----------------+---------------------------------------------------------------------------------+
| ≡ Dashboard    |                         Budget Management - December 2025                      |
|                |                                                                                 |
| 📊 Transactions | [ This Month Budget ] [ Last Month Review ] [ AI Suggestions ]                  |
|                | ────────────────────────────────────────────────────────────────────────────── |
| 💰 Budget       |                                                                                 |
|                | November 2025 Spending Review                                                   |
| 📈 Assets       | +-----------------------------------------------------------------------------+ |
|                | | Category          Spending     Budget      Difference   Trend (3 months)    | |
| 📑 Reports      | +-----------------------------------------------------------------------------+ |
|                | | 🍎 Food           ¥35,220     ¥40,000     -¥4,780      📊 ↑12% ▁▃▅        | |
| ⚙️ Settings     | | 🚃 Transportation ¥9,850      ¥10,000     -¥150        📊 ↓5%  ▅▃▁        | |
|                | | 🏠 Household      ¥90,000     ¥90,000     ¥0           📊 →0%  ▅▅▅        | |
|                | | 🎬 Entertainment  ¥18,930     ¥18,000     +¥930        📊 ↑8%  ▃▁▅        | |
|                | | ⚡ Utilities      ¥4,890      ¥6,000      -¥1,110      📊 ↓15% ▅▃▁        | |
|                | | 📦 Others         ¥12,340     ¥10,000     +¥2,340      📊 ↑18% ▁▃▅        | |
|                | +-----------------------------------------------------------------------------+ |
|                | | Total:            ¥171,230    ¥174,000    -¥2,770                          | |
|                | +-----------------------------------------------------------------------------+ |
|                |                                                                                 |
|                | Notable Expenses in November                                                    |
|                | +-----------------------------------------------------------------------------+ |
|                | | 📅 Nov 25  Year-end party preparation                           ¥8,500       | |
|                | | 📅 Nov 18  Winter clothes shopping                             ¥5,200       | |
|                | | 📅 Nov 12  Birthday dinner                                     ¥3,800       | |
|                | | 📅 Nov 08  Car maintenance                                     ¥4,500       | |
|                | +-----------------------------------------------------------------------------+ |
|                |                                                                                 |
|                | Weekly Spending Pattern                                                         |
|                | Week 1: ¥38,450  Week 2: ¥42,100  Week 3: ¥45,280  Week 4: ¥45,400          |
|                |                                                                                 |
+----------------+---------------------------------------------------------------------------------+

タブ「AI Suggestions」選択時:
+--------------------------------------------------------------------------------------------------+
|  FinSight                                                               AI User | Premium Plan    |
+----------------+---------------------------------------------------------------------------------+
| ≡ Dashboard    |                         Budget Management - December 2025                      |
|                |                                                                                 |
| 📊 Transactions | [ This Month Budget ] [ Last Month Review ] [ AI Suggestions ]                  |
|                | ────────────────────────────────────────────────────────────────────────────── |
| 💰 Budget       |                                                                                 |
|                | AI Budget Suggestions                                                           |
| 📈 Assets       | +-----------------------------------------------------------------------------+ |
|                | | Current AI Suggestions (ID: SUG-2025-12-001)          Status: Pending       | |
| 📑 Reports      | +-----------------------------------------------------------------------------+ |
|                | | Generated: 2025-12-01 10:00 | Type: Monthly Optimization                    | |
| ⚙️ Settings     | +-----------------------------------------------------------------------------+ |
|                | | Category          Current     Suggested    Difference    Reason             | |
|                | +-----------------------------------------------------------------------------+ |
|                | | 🍎 Food           ¥50,000     ¥45,000      -¥5,000      Past 3mo avg: ¥35k | |
|                | | 🚃 Transportation ¥10,000     ¥12,000      +¥2,000      Holiday season     | |
|                | | 🏠 Household      ¥90,000     ¥90,000      ¥0           Fixed cost         | |
|                | | 🎬 Entertainment  ¥20,000     ¥20,000      ¥0           Within range       | |
|                | | ⚡ Utilities      ¥5,000      ¥7,000       +¥2,000      Winter heating     | |
|                | | 📦 Others         ¥15,000     ¥15,000      ¥0           Stable pattern     | |
|                | +-----------------------------------------------------------------------------+ |
|                | | Total Impact: -¥1,000 | Optimization Score: 85%                             | |
|                | +-----------------------------------------------------------------------------+ |
|                |                                                                                 |
|                | Suggestion Actions                                                              |
|                | +-----------------------------------------------------------------------------+ |
|                | | [Accept All Suggestions]  [Reject Suggestions]  [Accept Selected]           | |
|                | |                                                                             | |
|                | | Optimization Type: [Monthly Balance ▼]  [Generate New Suggestions]          | |
|                | +-----------------------------------------------------------------------------+ |
|                |                                                                                 |
|                | Previous Suggestions History                                                    |
|                | +-----------------------------------------------------------------------------+ |
|                | | Date       | Type                | Status    | Savings                      | |
|                | | 2025-11-01 | Monthly Balance     | Accepted  | ¥3,000                       | |
|                | | 2025-10-01 | Cost Reduction      | Rejected  | -                            | |
|                | | 2025-09-01 | Monthly Balance     | Accepted  | ¥5,000                       | |
|                | +-----------------------------------------------------------------------------+ |
+----------------+---------------------------------------------------------------------------------+
```

### 画面要素説明

#### タブナビゲーション
- **This Month Budget**: 今月の予算設定画面（デフォルト）
- **Last Month Review**: 先月の支出実績詳細
- **AI Suggestions**: AI分析と提案の詳細
- **Comparison**: 月別比較ビュー

#### 「This Month Budget」タブ
- **予算設定テーブル**:
  - カテゴリアイコンで視覚的に識別
  - 先月実績を参考値として表示
  - 編集可能な予算入力フィールド
  - AI提案額と個別適用ボタン
- **月間進捗表示**:
  - 現在の消化状況をリアルタイム表示
  - プログレスバーで視覚化
  - 日付を考慮したペース表示

#### 「Last Month Review」タブ
- **支出サマリーテーブル**:
  - 実績vs予算の比較
  - 3ヶ月トレンドをスパークラインで表示
  - 前月比増減率
- **特筆すべき支出**:
  - 大きな支出を日付付きでリスト
- **週別支出パターン**:
  - 支出の週別推移を表示

#### 「AI Suggestions」タブ（別画面）
- **詳細分析結果**:
  - カテゴリ別の詳細な分析
  - 季節要因の説明
  - 類似ユーザーとの比較
- **最適化提案**:
  - 具体的な節約方法
  - リスクとメリット

#### アクションボタン
- **Save Budget**: 予算を保存（PUT /budgets/{budgetId}使用）
- **Reset to Last Month**: 先月と同じ予算にリセット
- **Accept All Suggestions**: AI提案を承認（PUT /budget-suggestions/{id}/accept）
- **Reject Suggestions**: AI提案を却下（PUT /budget-suggestions/{id}/reject）
- **Generate New Suggestions**: 新規AI提案生成（POST /budget-suggestions/generate）