# レポートページ 設計書

## ページ概要
指定期間の収支状況を詳細に分析し、レポートとして表示・共有するページです。月次・年次レポートの生成とメール送信機能を提供します。

## 主要機能

### 1. レポート期間選択
- **期間タイプ**:
  - 月次レポート
  - 四半期レポート
  - 年次レポート
  - カスタム期間
- **日付選択UI**: カレンダーまたはドロップダウン
- **クイック選択**: 先月、今月、過去3ヶ月、今年

### 2. レポートサマリー
- **主要指標カード**:
  - 期間内総支出
  - 期間内総収入
  - 収支バランス
  - 最大支出カテゴリと金額
- **前期間比較**: 
  - 増減額
  - 増減率（%）
  - トレンドアイコン（↑↓）

### 3. カテゴリ別支出分析
- **横棒グラフ**: カテゴリ別支出額
- **表示情報**:
  - 各カテゴリの支出額
  - 全体に占める割合（%）
  - 前期間との比較
- **ソート**: 金額順、カテゴリ名順
- **ドリルダウン**: カテゴリクリックで詳細表示

### 4. 支出トレンド分析
- **日別支出グラフ**: 期間内の日次推移
- **週別・月別集計**: 期間に応じて切り替え
- **移動平均線**: 7日/30日移動平均
- **異常値検出**: 通常と大きく異なる支出をハイライト

### 5. レポート共有機能
- **メール送信**:
  - 宛先メールアドレス入力
  - 件名自動生成
  - レポート形式選択（PDF/HTML）
- **ダウンロード**:
  - PDF形式
  - Excel形式
  - CSV形式
- **印刷**: 印刷用レイアウト最適化

### 6. インサイト・コメント
- **自動生成コメント**:
  - 支出傾向の分析
  - 前期間との主な違い
  - 改善提案
- **カスタムメモ**: ユーザーによる注記追加

## データ取得要件

### 必要なAPI
1. **レポートデータ取得API**
   - エンドポイント: `/api/reports/summary`
   - パラメータ:
     - from: 開始日
     - to: 終了日
     - group_by: daily/weekly/monthly
   - レスポンス: 期間内の集計データ

2. **カテゴリ別分析API**
   - エンドポイント: `/api/reports/category-analysis`
   - パラメータ:
     - from: 開始日
     - to: 終了日
   - レスポンス: カテゴリ別支出と前期間比較

3. **レポート送信API**
   - エンドポイント: `/api/reports/send`
   - メソッド: POST
   - リクエスト:
     ```json
     {
       "email": "user@example.com",
       "period": {
         "from": "2025-01-01",
         "to": "2025-01-31"
       },
       "format": "pdf",
       "include_insights": true
     }
     ```

4. **レポートエクスポートAPI**
   - エンドポイント: `/api/reports/export`
   - パラメータ:
     - format: pdf/excel/csv
     - period: 対象期間
   - レスポンス: ファイルダウンロードURL

### データベース参照
- `transactions`テーブル: 取引データ
- `categories`テーブル: カテゴリ情報
- `budgets`テーブル: 予算比較用

## UI/UX要件

### レイアウト
- **レスポンシブデザイン**: PC/タブレット/スマホ対応
- **印刷レイアウト**: A4サイズ最適化
- **グラフサイズ**: 画面幅に応じて自動調整

### インタラクティブ要素
- **グラフホバー**: 詳細数値表示
- **ズーム機能**: 特定期間の拡大表示
- **ドラッグ選択**: 期間選択の直感的操作

### パフォーマンス
- **レポート生成**: 5秒以内
- **PDF生成**: 10秒以内
- **キャッシュ**: 生成済みレポートの再利用

## レポート生成ロジック

### 集計ルール
- **期間設定**: タイムゾーン考慮（JST）
- **週の開始**: 月曜日始まり
- **月末処理**: 月の最終日まで含む

### インサイト生成
- **支出パターン分析**:
  - 曜日別傾向
  - 月内の支出分布
  - 季節性の検出
- **異常値検出**:
  - 標準偏差の2倍以上
  - 前月比50%以上の変動
- **改善提案**:
  - 高額支出カテゴリの指摘
  - 予算オーバー項目の警告

## メール送信仕様

### メールフォーマット
- **件名**: 「[FinSight] 2025年1月度 支出レポート」
- **本文**: HTML形式（テキスト版も併送）
- **添付**: PDFレポート（5MB以下）

### 送信タイミング
- **定期送信**: 月初に前月レポート自動送信
- **手動送信**: ユーザー操作による即時送信
- **送信履歴**: 送信記録の保持

## 実装優先順位
1. 基本的なレポート表示機能
2. 期間選択とデータ集計
3. カテゴリ別分析グラフ
4. PDF/Excelエクスポート
5. メール送信機能
6. AIによるインサイト生成

## 画面設計（ASCII）

```
+--------------------------------------------------------------------------------------------------+
|  FinSight                                                               AI User | Premium Plan    |
+----------------+---------------------------------------------------------------------------------+
| ≡ Dashboard    |                              Monthly Report                                     |
|                |                                                                                 |
| 📊 Transactions | Report Period: [September 1-30, 2025 ▼]                                        |
|                |                                                                                 |
| 💰 Budget       | +----------------------+  +----------------------+  +----------------------+   |
|                | | Total Expenses       |  | Top Category         |  | vs Last Month        |   |
| 📈 Assets       | |                      |  |                      |  |                      |   |
|                | |     ¥106,672        |  | 🍎 Food: ¥33,368     |  |  ▲ +¥12,450 (+13.2%)|   |
| 📑 Reports      | +----------------------+  +----------------------+  +----------------------+   |
|                |                                                                                 |
| ⚙️ Settings     | Category Expense Breakdown                                                      |
|                | +-----------------------------------------------------------------------+       |
|                | | Food (食費)          ████████████████████████████████ ¥33,368 (31.3%) |       |
|                | | Household (家賃)      ███████████████████████         ¥24,964 (23.4%) |       |
|                | | Others (その他)       ███████████████                 ¥16,605 (15.6%) |       |
|                | | Entertainment       ███████████████                 ¥16,361 (15.3%) |       |
|                | | Transportation      ██████████                      ¥10,301 (9.7%)  |       |
|                | | Utilities (光熱費)    █████                           ¥5,073  (4.8%)  |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | Daily Spending Trend                                                            |
|                | +-----------------------------------------------------------------------+       |
|                | | 8K┤    ╱╲                                                             |       |
|                | | 6K┤   ╱  ╲    ╱╲                    ╱╲                               |       |
|                | | 4K┤  ╱    ╲  ╱  ╲                  ╱  ╲         ╱╲                 |       |
|                | | 2K┤ ╱      ╲╱    ╲    ╱╲    ╱╲    ╱    ╲   ╱╲  ╱  ╲               |       |
|                | |  0┤─────────────────────────────────────────────────────────────── |       |
|                | |    1    5    10    15    20    25    30                             |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | Send Report                                                                     |
|                | +-----------------------------------------------------------------------+       |
|                | | Email: [user@example.com_______________] [Send Report via Email]     |       |
|                | | Export: [PDF ▼] [Download]                                            |       |
|                | +-----------------------------------------------------------------------+       |
+----------------+---------------------------------------------------------------------------------+
```

### 画面要素説明

#### 期間選択（上部）
- ドロップダウンで月次/四半期/年次/カスタム選択
- デフォルトは当月

#### サマリーカード（上部）
- **総支出額**: 期間内の支出合計
- **最大カテゴリ**: アイコン付きで表示
- **前期間比較**: 増減額と率

#### カテゴリ別支出グラフ（中央上）
- 横棒グラフ形式
- 金額と割合の両方を表示
- カテゴリ名は日本語併記
- バーの長さで視覚的に比較

#### 日別支出トレンドグラフ（中央下）
- 折れ線グラフで日次推移
- Y軸: 金額（K = 千円）
- X軸: 日付（5日間隔）
- 異常値はピークで確認可能

#### レポート送信エリア（下部）
- **メール送信**:
  - 宛先入力フィールド
  - 送信ボタン
- **エクスポート**:
  - 形式選択（PDF/Excel/CSV）
  - ダウンロードボタン