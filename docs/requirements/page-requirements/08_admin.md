# 管理者ページ 設計書

## ページ概要
スーパーユーザー専用のカテゴリマスタ管理ページです。URLを知っているスーパーユーザーのみがアクセス可能で、サイドバーには表示されません。システム全体のカテゴリマスタをCRUD操作できます。

## アクセス要件
- **URL**: `/admin/categories` （直接URLアクセスのみ）
- **権限**: スーパーユーザー権限必須
- **認証**: Auth0のroleクレームで`superuser`を確認
- **サイドバー**: 表示しない（意図的に隠す）

## 主要機能

### 1. カテゴリマスタ一覧表示
- **表示項目**:
  - ID（システムID）
  - カテゴリ名（日本語・英語）
  - アイコン
  - 色コード
  - 並び順
  - ステータス（有効/無効）
  - 作成日時
  - 更新日時
- **ソート機能**: ID、名前、並び順でソート可能
- **フィルタ**: 有効/無効でフィルタリング
- **ページネーション**: 20件ずつ表示

### 2. カテゴリ新規作成
- **入力項目**:
  - カテゴリ名（必須）
  - 英語名（必須）
  - アイコン（絵文字選択）
  - 色（カラーピッカー）
  - 並び順（数値）
  - 初期状態（有効/無効）
- **バリデーション**:
  - 名前の重複チェック
  - 並び順の数値チェック

### 3. カテゴリ編集
- **編集可能項目**: 全項目
- **インライン編集**: テーブル内で直接編集
- **一括更新**: 複数項目を同時に保存

### 4. カテゴリ削除
- **論理削除**: is_activeをfalseに設定
- **物理削除**: 使用されていないカテゴリのみ可能
- **確認ダイアログ**: 削除前に確認
- **影響範囲表示**: 使用中のユーザー数を表示

### 5. 一括操作
- **複数選択**: チェックボックスで選択
- **一括有効化/無効化**: 選択したカテゴリを一括更新
- **CSVエクスポート**: カテゴリマスタをCSVダウンロード

## 対応API・テーブル・ドメイン情報

### 関連API（管理者専用）
1. **GET /categories/master**
   - カテゴリマスタ一覧取得（管理者用）
   - パラメータ: page、limit、sort、filter（active/inactive/all）
   - レスポンス: 全フィールド含むカテゴリ情報

2. **POST /categories/master**
   - 新規カテゴリマスタ作成
   - リクエスト:
     ```json
     {
       "name": "医療費",
       "name_en": "Medical",
       "icon": "🏥",
       "color": "#FF6B6B",
       "sort_order": 10,
       "is_active": true
     }
     ```

3. **PUT /categories/master/{categoryId}**
   - カテゴリマスタ更新
   - リクエスト: 変更したいフィールドのみ

4. **DELETE /categories/master/{categoryId}**
   - カテゴリマスタ削除（物理削除）
   - 条件: 使用中でないこと
   - レスポンス: 削除確認メッセージ

5. **GET /categories/master/{categoryId}/usage**
   - カテゴリ使用状況確認
   - レスポンス: 使用中のユーザー数、取引数

6. **POST /categories/master/bulk-update**
   - 複数カテゴリ一括更新
   - リクエスト: カテゴリIDの配列と更新内容

### 対応テーブル
- **category_master**: システムカテゴリマスタ
- **user_categories**: ユーザーとカテゴリの関連
- **transactions**: カテゴリ使用状況確認用

### 関連ドメインエンティティ
- **CategoryMaster集約**: システムレベルのカテゴリ管理
- **AdminUser集約**: 管理者権限とアクセス制御

## UI/UX要件

### デザイン
- **管理画面風**: シンプルで機能的なデザイン
- **テーブル中心**: データグリッド形式
- **高密度表示**: 多くの情報を効率的に表示

### 操作性
- **キーボードショートカット**: 
  - Ctrl+N: 新規作成
  - Ctrl+S: 保存
  - Delete: 削除
- **一括編集**: Shift+クリックで範囲選択
- **ドラッグ&ドロップ**: 並び順の変更

### フィードバック
- **自動保存**: 編集内容を自動保存
- **変更履歴**: 誰がいつ変更したか記録
- **エラー表示**: 明確なエラーメッセージ

## セキュリティ要件

### アクセス制御
- **ロールチェック**: Auth0のroleクレームを検証
- **IPアドレス制限**: 特定IPからのみアクセス可能（オプション）
- **アクセスログ**: 全操作を記録

### データ保護
- **監査ログ**: 全CRUD操作を記録
- **変更前データ**: 更新・削除前のデータを保存
- **バックアップ**: 定期的なバックアップ

## エラーハンドリング

### 権限エラー
- **403 Forbidden**: スーパーユーザー以外のアクセス
- **リダイレクト**: ホーム画面へ自動リダイレクト

### データエラー
- **重複エラー**: 「このカテゴリ名は既に存在します」
- **使用中エラー**: 「このカテゴリは〇〇件の取引で使用されています」
- **検証エラー**: フィールドレベルでのエラー表示

## 実装優先順位
1. 認証・認可チェック
2. カテゴリ一覧表示
3. 新規作成・編集機能
4. 削除機能（論理削除）
5. 一括操作・CSVエクスポート

## 画面設計（ASCII）

```
+--------------------------------------------------------------------------------------------------+
|  FinSight Admin                                                         Superuser | Logout        |
+--------------------------------------------------------------------------------------------------+
|                              Category Master Management                                          |
|                                                                                                  |
| [+ New Category] [Bulk Actions ▼] [Export CSV]                              Filter: [All ▼]     |
|                                                                                                  |
| +----------------------------------------------------------------------------------------------+|
| |□| ID | Name (JP)  | Name (EN)      | Icon | Color    | Order | Status | Actions             ||
| |--|---|------------|----------------|------|----------|-------|--------|--------------------||
| |□| 1  | 食費       | Food           | 🍎   | #4CAF50  | 1     | Active | [Edit] [Delete]    ||
| |□| 2  | 家賃・住居費| Household      | 🏠   | #2196F3  | 2     | Active | [Edit] [Delete]    ||
| |□| 3  | 光熱費     | Utilities      | ⚡   | #FF9800  | 3     | Active | [Edit] [Delete]    ||
| |□| 4  | 交通費     | Transportation | 🚃   | #9C27B0  | 4     | Active | [Edit] [Delete]    ||
| |□| 5  | エンター... | Entertainment  | 🎬   | #F44336  | 5     | Active | [Edit] [Delete]    ||
| |□| 6  | その他     | Others         | 📦   | #607D8B  | 6     | Active | [Edit] [Delete]    ||
| |□| 7  | 給与・収入  | Salary/Income  | 💰   | #00BCD4  | 7     | Active | [Edit] [Delete]    ||
| |□| 8  | 医療費     | Medical        | 🏥   | #FF6B6B  | 8     | Inactive| [Edit] [Delete]    ||
| +----------------------------------------------------------------------------------------------+|
|                                                                                                  |
| Showing 1-8 of 8 categories                                            [Previous] [1] [Next]     |
|                                                                                                  |
| +----------------------------------------------------------------------------------------------+|
| | Add New Category                                                                             ||
| |                                                                                              ||
| | Name (JP): [_______________]  Name (EN): [_______________]                                   ||
| |                                                                                              ||
| | Icon: [🍎▼]  Color: [#4CAF50 🎨]  Sort Order: [9___]  Status: [Active ▼]                    ||
| |                                                                                              ||
| | [Cancel] [Save Category]                                                                     ||
| +----------------------------------------------------------------------------------------------+|
|                                                                                                  |
| Activity Log                                                                                     |
| +----------------------------------------------------------------------------------------------+|
| | 2025-09-20 14:30 | superuser@example.com | Updated category "食費"                           ||
| | 2025-09-20 14:25 | superuser@example.com | Created category "医療費"                         ||
| | 2025-09-20 14:20 | superuser@example.com | Deleted category "Test"                          ||
| +----------------------------------------------------------------------------------------------+|
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
```

### 画面要素説明

#### ヘッダー
- **タイトル**: 「FinSight Admin」で管理画面であることを明示
- **ユーザー表示**: スーパーユーザー権限を表示
- **ログアウト**: 明確なログアウトボタン

#### アクションバー
- **新規作成ボタン**: 目立つ位置に配置
- **一括操作**: 選択したアイテムに対する操作
- **CSVエクスポート**: データダウンロード機能
- **フィルタ**: Active/Inactive/Allで絞り込み

#### カテゴリテーブル
- **チェックボックス**: 一括選択用
- **ID**: システム管理用ID表示
- **日本語名・英語名**: 両方を表示
- **視覚的要素**: アイコンと色を直接表示
- **ステータス**: Active/Inactiveを明示
- **アクション**: 編集・削除ボタン

#### 新規作成フォーム
- **インラインフォーム**: ページ遷移なしで追加
- **必須項目**: 日本語名と英語名
- **プレビュー**: アイコンと色を即座に確認

#### アクティビティログ
- **監査証跡**: 最近の変更履歴を表示
- **実行者**: メールアドレスで特定
- **操作内容**: 何をしたか明確に記載

### 操作フロー

1. **カテゴリ追加**:
   - 「New Category」クリック
   - フォームに入力
   - 「Save Category」で保存

2. **カテゴリ編集**:
   - テーブル内の「Edit」クリック
   - インライン編集モードへ
   - 変更後自動保存

3. **カテゴリ削除**:
   - 「Delete」クリック
   - 使用状況確認ダイアログ
   - 確認後削除実行

4. **一括操作**:
   - チェックボックスで複数選択
   - 「Bulk Actions」から操作選択
   - 一括実行