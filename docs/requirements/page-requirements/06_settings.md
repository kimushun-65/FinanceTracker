# 設定ページ 設計書

## ページ概要
ユーザーが使用するカテゴリの選択、メール通知設定（送信日程・メールアドレス）、プロフィール管理、通知設定などを行う設定ページです。

## 主要機能

### 1. カテゴリ選択設定
- **使用カテゴリの選択**:
  - デフォルトカテゴリ一覧から使用するカテゴリを選択
  - チェックボックスでON/OFF切り替え
  - 使用中のカテゴリのみ取引入力時に表示
- **デフォルトカテゴリ**:
  - 食費（Food）
  - 家賃・住居費（Household）
  - 光熱費（Utilities）
  - 交通費（Transportation）
  - エンターテインメント（Entertainment）
  - その他（Others）
  - 収入（Salary/Income）

### 2. プロファイル管理
- **表示項目**:
  - ユーザー名
  - メールアドレス
  - 登録日
- **編集機能**:
  - ユーザー名変更
  - メールアドレス変更

### 3. メール通知設定
- **通知タイプ**:
  - 月次レポート送信（ON/OFF）
  - 予算超過アラート（ON/OFF）
- **メール配信設定**:
  - 送信先メールアドレス（プロファイルと別に設定可能）
  - 月次レポート送信日（毎月1日〜28日から選択）
  - 送信時刻（0時〜23時から選択）
- **アラート設定**:
  - 予算消化率の閾値（70%、80%、90%から選択）

### 4. その他の通知設定
- **アプリ内通知**:
  - リアルタイムアラート（ON/OFF）
  - 取引リマインダー（ON/OFF）

## 対応API・テーブル・ドメイン情報

### 関連API
1. **GET /users/me**
   - ユーザー基本情報取得（プロフィール表示用）
   - レスポンス: user_id、email、created_at、updated_at

2. **PUT /users/me**
   - メールアドレス更新
   - リクエスト: email
   - レスポンス: 更新されたユーザー情報

3. **GET /categories**
   - ユーザーカテゴリ一覧取得（マスター＋カスタム）
   - レスポンス: id、name、icon、color、is_custom、sort_order、is_active

4. **PUT /categories/{categoryId}**
   - カテゴリ更新（主にis_activeの切り替えに使用）
   - リクエスト: is_active（true/false）
   - 使用中カテゴリのON/OFF切り替え

5. **DELETE /categories/{categoryId}**
   - カテゴリの無効化（物理削除ではない）
   - レスポンス: is_active: falseに設定されたカテゴリ情報

6. **GET /notifications/settings**
   - 通知設定取得
   - レスポンス: monthly_report（enabled、send_day、send_time）、budget_exceeded_alert（enabled、threshold）

7. **PUT /notifications/settings**
   - 通知設定更新
   - リクエスト: 
     ```json
     {
       "monthly_report": {
         "enabled": true,
         "send_day": 1,
         "send_time": "09:00"
       },
       "budget_exceeded_alert": {
         "enabled": true,
         "threshold": 80
       }
     }
     ```
   - 通知先メールアドレスはユーザープロフィールのemailを使用

### 対応テーブル
- **users**: ユーザープロフィール情報（名前、メール、登録日）
- **user_categories**: ユーザーが使用するカテゴリの選択状態
- **category_master**: システムデフォルトカテゴリマスタ
- **notification_settings**: ユーザー別通知設定（メール通知、送信日時、閾値）

### 関連ドメインエンティティ
- **User集約**: ユーザーアカウントのライフサイクル管理
  - Userエンティティ: 基本ユーザー情報
  - UserProfile値オブジェクト: プロフィール管理ロジック
- **Category集約**: カテゴリマスタ管理とカスタマイズ機能
  - CategoryMasterエンティティ: システムデフォルトカテゴリ
  - UserCategoryエンティティ: ユーザーカスタムカテゴリ
- **NotificationSetting集約**: 通知設定管理
- **DataExport集約**: データエクスポート処理ロジック

## UI/UX要件

### レイアウト
- **セクション分け**: アコーディオンまたはタブ形式
- **設定項目グループ化**: 関連項目をまとめて表示
- **保存ボタン**: 各セクションごとまたは一括保存

### バリデーション
- **メールアドレス**: 形式チェック、重複チェック
- **パスワード**: 強度チェック、確認入力
- **カテゴリ名**: 必須入力、重複チェック

### フィードバック
- **保存成功**: トースト通知
- **エラー表示**: インライン表示
- **確認ダイアログ**: 削除操作時

## セキュリティ要件

### 認証・認可
- **パスワード変更**: 現在のパスワード確認必須
- **メールアドレス変更**: 確認メール送信
- **セッション管理**: 設定変更後の再認証

### データ保護
- **エクスポートデータ**: 暗号化ZIP
- **APIキー**: 表示時マスキング
- **削除操作**: 論理削除後、物理削除

## ビジネスロジック

### カテゴリ選択ルール
- **デフォルト状態**: 全カテゴリON
- **最低選択数**: 最低1つは選択必須
- **取引との連動**: OFFにしたカテゴリの既存取引は影響を受けない

### 通知ルール
- **月次レポート送信**: 指定日の指定時刻に自動送信
- **送信日制限**: 29日以降は選択不可（2月対応）
- **タイムゾーン**: JST固定
- **失敗時リトライ**: 3回まで再送信

## 実装優先順位
1. カテゴリ選択機能
2. プロファイル表示・編集
3. メール通知設定（アドレス・送信日時）
4. その他の通知設定

## 画面設計（ASCII）

```
+--------------------------------------------------------------------------------------------------+
|  FinSight                                                               AI User | Premium Plan    |
+----------------+---------------------------------------------------------------------------------+
| ≡ Dashboard    |                              Settings                                           |
|                |                                                                                 |
| 📊 Transactions | +-----------------------------------------------------------------------+       |
|                | | Profile                                                               |       |
| 💰 Budget       | |  AI User                                                              |       |
|                | |  ai.user@example.com                                                 |       |
| 📈 Assets       | |  Member since: 2025/01/01                                            |       |
|                | |  [Edit Profile]                                                      |       |
| 📑 Reports      | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
| ⚙️ Settings     | +-----------------------------------------------------------------------+       |
|                | | Category Selection                                                    |       |
|                | | Select categories to use in your transactions:                       |       |
|                | |                                                                      |       |
|                | | [✓] 🍎 Food (食費)                                                    |       |
|                | | [✓] 🏠 Household (家賃・住居費)                                          |       |
|                | | [✓] ⚡ Utilities (光熱費)                                              |       |
|                | | [✓] 🚃 Transportation (交通費)                                         |       |
|                | | [✓] 🎬 Entertainment (エンターテインメント)                                |       |
|                | | [✓] 📦 Others (その他)                                                |       |
|                | | [ ] 💰 Salary/Income (給与・収入)                                       |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | +-----------------------------------------------------------------------+       |
|                | | Email Notification Settings                                           |       |
|                | |                                                                      |       |
|                | | Notification Email Address: [ai.user@example.com__________]          |       |
|                | |                                                                      |       |
|                | | Monthly Report:            [ON] OFF                                  |       |
|                | |   Send Day:               [1st of month ▼]                          |       |
|                | |   Send Time:              [9:00 AM ▼]                               |       |
|                | |                                                                      |       |
|                | | Budget Alert:             ON [OFF]                                   |       |
|                | |   Alert Threshold:        [80% ▼]                                   |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | +-----------------------------------------------------------------------+       |
|                | | Other Notifications                                                   |       |
|                | |                                                                      |       |
|                | | In-app Notifications:     [ON] OFF                                   |       |
|                | | Transaction Reminders:    ON [OFF]                                   |       |
|                | +-----------------------------------------------------------------------+       |
|                |                                                                                 |
|                | [Save Settings]                                                                |
|                |                                                                                 |
+----------------+---------------------------------------------------------------------------------+
```

### 画面要素説明

#### プロファイルセクション（上部）
- **ユーザー情報**: 名前、メールアドレス、登録日
- **編集リンク**: プロファイル編集画面へ

#### カテゴリ選択セクション（上中部）
- **チェックボックスリスト**:
  - 各カテゴリにチェックボックス
  - カテゴリ名（日本語併記）
  - アイコンで視覚的に識別
- **使用説明**: 「Select categories to use in your transactions」

#### メール通知設定セクション（中部）
- **通知先メールアドレス**: 編集可能なテキストフィールド
- **月次レポート設定**:
  - ON/OFFトグル
  - 送信日選択（1日〜28日）
  - 送信時刻選択（0時〜23時）
- **予算アラート設定**:
  - ON/OFFトグル
  - 閾値選択（70%、80%、90%）

#### その他の通知セクション（下部）
- **アプリ内通知**: ON/OFFトグル
- **取引リマインダー**: ON/OFFトグル

#### 保存ボタン
- **Save Settings**: 全設定を一括保存

#### 視覚的要素
- チェックボックスで選択状態を明確化
- トグルスイッチでON/OFF状態を表示
- ドロップダウンで選択肢を提供